<div class="container mt-5">
  <h2 class="mb-4 text-center">
    <i class="bi bi-person-circle me-2"></i>Meu Perfil
  </h2>

  {{#if user}}
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div id="perfilAlert"></div>

      <div class="bg-white p-4 rounded shadow-sm text-center">
        
        <!-- Imagem de Perfil -->
        <img id="profileImage"
             src="{{#if user.photoURL}}{{user.photoURL}}{{else}}/img/default-avatar.png{{/if}}"
             class="rounded-circle mb-3 shadow-sm"
             alt="Foto de perfil"
             style="width: 120px; height: 120px; object-fit: cover;">

        <!-- Visualiza√ß√£o -->
        <div id="perfilView">
          <p><strong>Nome:</strong> <span id="viewName">{{user.displayName}}</span></p>
          <p><strong>Email:</strong> <span id="viewEmail">{{user.email}}</span></p>

          <div class="text-end mt-4">
            <button id="editBtn" class="btn btn-primary">
              <i class="bi bi-pencil-square me-1"></i>Editar perfil
            </button>
            <a href="/" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i>Voltar
            </a>
          </div>
        </div>

        <!-- Formul√°rio de edi√ß√£o -->
        <form id="perfilForm" class="d-none mt-3 text-start">
          <div class="text-center mb-3">
            <input type="file" id="photoInput" accept="image/*" class="form-control mt-2">
            <div class="form-text">Selecione uma nova foto (opcional)</div>
          </div>

          <div class="mb-3">
            <label for="displayName" class="form-label">Nome completo</label>
            <input type="text" id="displayName" class="form-control" value="{{user.displayName}}" required>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" class="form-control" value="{{user.email}}" readonly>
            <div class="form-text">O email n√£o pode ser alterado.</div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-2">
            <div>
              <button type="submit" class="btn btn-success">
                <span id="saveSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                Salvar altera√ß√µes
              </button>
              <button type="button" id="cancelEditBtn" class="btn btn-outline-secondary ms-2">
                Cancelar
              </button>
            </div>

            <!-- üóëÔ∏è Bot√£o de excluir conta -->
            <button type="button" id="deleteAccountBtn" class="btn btn-danger">
              <i class="bi bi-trash-fill me-1"></i>Excluir conta
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {{else}}
  <div class="alert alert-warning text-center mt-5">
    Voc√™ precisa estar logado para acessar esta p√°gina. <a href="/login" class="fw-semibold">Fazer login</a>
  </div>
  {{/if}}
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAl7UODazn1P_Y3bz1fG5c94z4nLvP2iDU",
    authDomain: "desapega-kids.firebaseapp.com",
    projectId: "desapega-kids",
    storageBucket: "desapega-kids.firebasestorage.app",
    messagingSenderId: "617286670076",
    appId: "1:617286670076:web:dd859fff720c4fc6512979",
    measurementId: "G-99FYXVZ13K"
  };
  firebase.initializeApp(firebaseConfig);
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const perfilForm = document.getElementById('perfilForm');
  const perfilView = document.getElementById('perfilView');
  const alertDiv = document.getElementById('perfilAlert');
  const saveSpinner = document.getElementById('saveSpinner');
  const editBtn = document.getElementById('editBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const deleteAccountBtn = document.getElementById('deleteAccountBtn');
  const photoInput = document.getElementById('photoInput');
  const profileImage = document.getElementById('profileImage');
  let photoBase64 = null;

  function showAlert(message, type = 'success') {
    alertDiv.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show mt-3">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }

  function setLoading(loading) {
    if (loading) saveSpinner.classList.remove('d-none');
    else saveSpinner.classList.add('d-none');
  }

  photoInput?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        photoBase64 = event.target.result;
        profileImage.src = photoBase64;
      };
      reader.readAsDataURL(file);
    }
  });

  editBtn?.addEventListener('click', () => {
    perfilView.classList.add('d-none');
    perfilForm.classList.remove('d-none');
  });

  cancelEditBtn?.addEventListener('click', () => {
    perfilForm.classList.add('d-none');
    perfilView.classList.remove('d-none');
    photoBase64 = null;
    photoInput.value = '';
  });

  firebase.auth().onAuthStateChanged((user) => {
    if (!user) {
      showAlert("Voc√™ precisa estar logado para editar o perfil.", "danger");
      editBtn.disabled = true;
      return;
    }

    // üß© Excluir conta
deleteAccountBtn?.addEventListener('click', async () => {
  if (!confirm("Tem certeza que deseja excluir sua conta? Esta a√ß√£o √© irrevers√≠vel.")) return;

  try {
    const idToken = await user.getIdToken();

    // 1Ô∏è‚É£ Exclui o usu√°rio no Firebase Auth (cliente)
    await user.delete();

    // 2Ô∏è‚É£ Depois chama o backend para limpar Firestore e sess√£o
    const res = await fetch('/api/auth/delete', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idToken, uid: user.uid })
    });

    if (!res.ok) throw new Error('Erro ao excluir conta no servidor.');

    // 3Ô∏è‚É£ Toast e redirecionamento
    sessionStorage.setItem('accountDeleted', 'true');
    window.location.href = '/register';
  } catch (error) {
    console.error(error);
    showAlert('Erro ao excluir conta. Tente novamente.', 'danger');
  }
});



    // üß© Atualizar perfil
    perfilForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      setLoading(true);

      const displayName = document.getElementById('displayName').value.trim();

      try {
        const idToken = await user.getIdToken();

        const body = {
          idToken,
          displayName,
          uid: user.uid,
          photoBase64: photoBase64
        };

        const response = await fetch('/api/auth/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) throw new Error('Erro ao salvar no servidor');
        const data = await response.json();

        document.getElementById('viewName').textContent = displayName;
        if (data.photoURL) profileImage.src = data.photoURL;

        showAlert('Informa√ß√µes atualizadas com sucesso!', 'success');
        perfilForm.classList.add('d-none');
        perfilView.classList.remove('d-none');
      } catch (error) {
        console.error(error);
        showAlert('Erro ao atualizar perfil. Tente novamente.', 'danger');
      } finally {
        setLoading(false);
      }
    });
  });
});
</script>
